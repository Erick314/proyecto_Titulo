<div class="container-fluid min-vh-100 py-4">
  <div class="row">
    <h2 class="text-center fw-bold mb-4">INVENTARIO</h2>

    <div
      class="row justify-content-center mb-4 gap-2 px-3 flex-wrap text-center"
    >
      <div class="col-auto">
        <mat-form-field>
          <mat-label>Sucursal</mat-label>
          <mat-select
            [(ngModel)]="sucursalSeleccionada"
            (selectionChange)="onSucursalChange()"
          >
            <mat-option value="todas">Todas</mat-option>
            <mat-option
              *ngFor="let sucursal of sucursales"
              [value]="sucursal.nombre"
              >{{ sucursal.nombre }}</mat-option
            >
          </mat-select>
        </mat-form-field>
      </div>

      <div class="col-auto">
        <div class="input-group rounded-pill d-flex align-items-center">
          <span class="input-group-text border-end-0" style="line-height: 1">
            <span
              class="material-symbols-outlined"
              style="font-size: 24px; vertical-align: middle"
              >search</span
            >
          </span>
          <input
            type="text"
            class="form-control border-start-0"
            placeholder="Filtrar producto"
            [(ngModel)]="searchTerm"
            (input)="applyFilter()"
          />
        </div>
      </div>

      <div class="col-auto">
        <button
          class="btn btn-success px-4 py-2"
          (click)="exportarMovimientosAExcel()"
        >
          Exportar en Excel
        </button>
      </div>

      <div class="col-auto">
        <button
          class="form-control rounded-pill px-4 py-2 d-flex align-items-center gap-2 bg-success-subtle"
          (click)="abrirModalNuevoProducto()"
        >
          <span class="material-symbols-outlined text-success">add</span>
          Nuevo Producto
        </button>
      </div>
    </div>
  </div>

  <div class="table-responsive px-3">
    <table mat-table [dataSource]="dataSource" class="mat-elevation-z8" matSort>
      <ng-container matColumnDef="sucursalNombre">
        <th mat-header-cell *matHeaderCellDef matSortHeader class="text-center">
          SUCURSAL
        </th>
        <td mat-cell *matCellDef="let producto" class="text-center">
          {{ producto.sucursalNombre }}
        </td>
      </ng-container>

      <ng-container matColumnDef="nombreProducto">
        <th mat-header-cell *matHeaderCellDef matSortHeader class="text-center">
          PRODUCTO
        </th>
        <td mat-cell *matCellDef="let producto" class="text-center">
          <a
            class="pdf-icon-link"
            style="cursor: pointer"
            (click)="mostrarHistorial(producto.id)"
            >{{ producto.nombreProducto }}</a
          >
          <br />
          <small class="text-muted">{{ producto.detalles }}</small>
        </td>
      </ng-container>

      <ng-container matColumnDef="stockActual">
        <th mat-header-cell *matHeaderCellDef matSortHeader class="text-center">
          STOCK
        </th>
        <td mat-cell *matCellDef="let producto" class="text-center">
          <div
            [class.text-danger]="producto.stockActual <= producto.stockMinimo"
            [class.fw-bold]="producto.stockActual <= producto.stockMinimo"
            [class.stock-minimo-alert]="
              producto.stockActual <= producto.stockMinimo
            "
          >
            <span
              class="text-danger fs-4"
              style="cursor: pointer"
              (click)="decrementarStock(producto)"
              >➖</span
            >
            <input
              type="number"
              class="stock-input"
              [(ngModel)]="producto.stockActual"
              (blur)="actualizarStockDirecto(producto)"
              (keyup.enter)="actualizarStockDirecto(producto)"
              min="0"
              [class.text-danger]="producto.stockActual <= producto.stockMinimo"
              [class.fw-bold]="producto.stockActual <= producto.stockMinimo"
            />
            <span
              class="text-success fs-4"
              style="cursor: pointer"
              (click)="incrementarStock(producto)"
              >➕</span
            >
          </div>
          <small
            *ngIf="producto.stockActual <= producto.stockMinimo"
            class="text-danger fw-bold"
          >
            ⚠️ Stock mínimo: {{ producto.stockMinimo }}
          </small>
        </td>
      </ng-container>

      <ng-container matColumnDef="estado">
        <th mat-header-cell *matHeaderCellDef matSortHeader class="text-center">
          ESTADO
        </th>
        <td mat-cell *matCellDef="let producto" class="text-center">
          <span
            [class]="
              producto.estado === 'ACTIVO'
                ? 'badge bg-success'
                : 'badge bg-secondary'
            "
          >
            {{ producto.estado }}
          </span>
        </td>
      </ng-container>

      <ng-container matColumnDef="opciones">
        <th mat-header-cell *matHeaderCellDef class="text-center">OPCIONES</th>
        <td mat-cell *matCellDef="let producto" class="text-center">
          <span
            class="material-symbols-outlined mx-1 text-primary-dark"
            style="cursor: pointer"
            (click)="abrirEditor(producto)"
            >settings</span
          >
          <span
            class="material-symbols-outlined mx-1 text-success"
            style="cursor: pointer"
            (click)="solicitarConfirmacionGuardado(producto)"
            >save</span
          >
          <span
            class="material-symbols-outlined text-danger mx-1"
            style="cursor: pointer"
            (click)="solicitarConfirmacionEliminar(producto)"
            >delete</span
          >
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
    </table>

    <mat-paginator
      [pageSizeOptions]="[10, 25, 50, 100]"
      showFirstLastButtons
    ></mat-paginator>
  </div>

  <div class="overlay" *ngIf="mostrarModalConfirmacion">
    <div class="edit-card">
      <h2>{{ mensajeConfirmacion }}</h2>
      <div class="modal-buttons">
        <button class="custom-button-green" (click)="confirmarAccion()">
          CONFIRMAR
        </button>
        <button class="custom-button-red" (click)="cerrarModalConfirmacion()">
          CANCELAR
        </button>
      </div>
    </div>
  </div>

  <div class="overlay" *ngIf="selectedProducto" (click)="cerrarEditor()">
    <div class="edit-card" (click)="$event.stopPropagation()">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="m-0">Editar Producto</h5>
        <button
          class="btn-close"
          aria-label="Cerrar"
          (click)="cerrarEditor()"
        ></button>
      </div>

      <div *ngIf="validationError" class="alert alert-danger py-1">
        {{ validationError }}
      </div>

      <div>
        <label class="form-label"
          >Nombre <span class="text-danger">*</span></label
        >
        <input
          type="text"
          class="form-control mb-2"
          [(ngModel)]="selectedProducto.nombreProducto"
          required
        />

        <label class="form-label"
          >Stock <span class="text-danger">*</span></label
        >
        <input
          type="number"
          class="form-control mb-2"
          [(ngModel)]="selectedProducto.stockActual"
          required
        />

        <label class="form-label">Detalles</label>
        <textarea
          class="form-control mb-3"
          rows="2"
          [(ngModel)]="selectedProducto.detalles"
        ></textarea>

        <button class="custom-button-green w-100" (click)="guardarProducto()">
          Guardar
        </button>
      </div>
    </div>
  </div>
</div>

<div class="overlay" *ngIf="productoSeleccionado" (click)="cerrarHistorial()">
  <div
    class="detalle-producto-card edit-card historial-modal-content"
    (click)="$event.stopPropagation()"
  >
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h2 class="m-0">{{ productoSeleccionado.nombreProducto | uppercase }}</h2>
      <button
        type="button"
        class="btn-close"
        aria-label="Cerrar"
        (click)="cerrarHistorial()"
      ></button>
    </div>
    
    <!-- Información del producto -->
    <div class="producto-info mb-4">
      <p class="descripcion mb-2">{{ productoSeleccionado.descripcionProducto }}</p>
      <div class="row">
        <div class="col-md-6">
          <strong>Sucursal:</strong> {{ productoSeleccionado.sucursalNombre }}
        </div>
        <div class="col-md-6">
          <strong>Stock Actual:</strong> 
          <span [class.text-danger]="productoSeleccionado.stockActual <= productoSeleccionado.stockMinimo"
                [class.fw-bold]="productoSeleccionado.stockActual <= productoSeleccionado.stockMinimo">
            {{ productoSeleccionado.stockActual }}
          </span>
        </div>
      </div>
      <div class="row mt-2">
        <div class="col-md-6">
          <strong>Stock Mínimo:</strong> {{ productoSeleccionado.stockMinimo }}
        </div>
        <div class="col-md-6">
          <strong>Estado:</strong> 
          <span [class]="productoSeleccionado.estado === 'ACTIVO' ? 'badge bg-success' : 'badge bg-secondary'">
            {{ productoSeleccionado.estado }}
          </span>
        </div>
      </div>
    </div>

    <!-- Loader para historial -->
    <div *ngIf="cargandoHistorial" class="text-center py-5">
      <div class="spinner-border text-success" style="width: 3rem; height: 3rem;" role="status">
        <span class="visually-hidden">Cargando movimientos...</span>
      </div>
      <div class="mt-2 text-success">Cargando movimientos...</div>
    </div>

    <!-- Tabla de movimientos -->
    <div class="table-responsive" *ngIf="!cargandoHistorial">
      <table
        mat-table
        [dataSource]="dataSourceHistorial"
        class="mat-elevation-z1 w-100"
        matSort
        #sortHistorial
      >
        <ng-container matColumnDef="cantidad">
          <th mat-header-cell *matHeaderCellDef matSortHeader class="text-center">
            CANTIDAD
          </th>
          <td mat-cell *matCellDef="let row" class="text-center fw-bold">
            {{ row.cantidad }}
          </td>
        </ng-container>

        <ng-container matColumnDef="tipo">
          <th mat-header-cell *matHeaderCellDef matSortHeader class="text-center">
            TIPO
          </th>
          <td
            mat-cell
            *matCellDef="let row"
            class="text-center align-middle"
            style="vertical-align: middle; padding: 0;"
          >
            <div class="d-flex align-items-center justify-content-center gap-2" style="height: 100%; min-height: 32px;">
              <span *ngIf="row.tipo === 'ENTRADA'" class="text-success fs-5">▶</span>
              <span *ngIf="row.tipo === 'SALIDA'" class="text-danger fs-5">◀</span>
              <span *ngIf="row.tipo === 'AJUSTE'" class="text-warning fs-5">⚙</span>
              <span [class]="row.tipo === 'ENTRADA' ? 'text-success' : row.tipo === 'SALIDA' ? 'text-danger' : 'text-warning'" style="font-weight: 500;">
                {{ row.tipo }}
              </span>
            </div>
          </td>
        </ng-container>

        <ng-container matColumnDef="fecha">
          <th mat-header-cell *matHeaderCellDef matSortHeader class="text-center">
            FECHA Y HORA
          </th>
          <td mat-cell *matCellDef="let row" class="text-center">
            {{ row.fecha | date : "dd/MM/yyyy HH:mm" }}
          </td>
        </ng-container>

        <ng-container matColumnDef="motivo">
          <th mat-header-cell *matHeaderCellDef class="text-center">
            MOTIVO
          </th>
          <td mat-cell *matCellDef="let row" class="text-start">
            <span class="text-muted">{{ row.motivo }}</span>
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumnsHistorial"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumnsHistorial"></tr>
      </table>
    </div>

    <!-- Paginador -->
    <mat-paginator
      #paginatorHistorial
      [pageSizeOptions]="[5, 10, 25, 50]"
      [pageSize]="10"
      showFirstLastButtons
      class="mt-3"
    ></mat-paginator>

    <!-- Mensaje cuando no hay movimientos -->
    <div *ngIf="!cargandoHistorial && dataSourceHistorial.data.length === 0" class="text-center py-4">
      <p class="text-muted">No hay movimientos registrados para este producto.</p>
    </div>
  </div>
</div>

<div
  class="overlay"
  *ngIf="mostrarModalNuevoProducto"
  (click)="cerrarModalNuevoProducto()"
>
  <div class="edit-card" (click)="$event.stopPropagation()">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h5 class="m-0">Agregar Producto al Inventario</h5>
      <button
        class="btn-close"
        aria-label="Cerrar"
        (click)="cerrarModalNuevoProducto()"
      ></button>
    </div>

    <div *ngIf="validationError" class="alert alert-danger py-1">
      {{ validationError }}
    </div>

    <div>
      <label class="form-label">Sucursal</label>
      <mat-form-field class="w-100 mb-2">
        <mat-select
          [(ngModel)]="nuevoProducto.sucursalId"
          placeholder="Seleccione una sucursal"
        >
          <mat-option
            *ngFor="let sucursal of sucursales"
            [value]="sucursal.id"
            >{{ sucursal.nombre }}</mat-option
          >
        </mat-select>
      </mat-form-field>

      <label class="form-label">Producto</label>
      <mat-form-field class="w-100 mb-2">
        <mat-select
          [(ngModel)]="nuevoProducto.productoId"
          placeholder="Seleccione un producto"
        >
          <mat-option *ngFor="let producto of productos" [value]="producto.id">
            {{ producto.nombre }} - {{ producto.categoria }} ({{
              producto.cantidadUnidadMedida
            }}{{ producto.unidadMedida }})
          </mat-option>
        </mat-select>
      </mat-form-field>

      <label class="form-label">Stock Actual</label>
      <input
        type="number"
        class="form-control mb-2"
        [(ngModel)]="nuevoProducto.stockActual"
        placeholder="0"
        min="0"
        required
      />

      <label class="form-label">Stock Mínimo</label>
      <input
        type="number"
        class="form-control mb-3"
        [(ngModel)]="nuevoProducto.stockMinimo"
        placeholder="0"
        min="0"
        required
      />

      <button
        class="btn btn-success w-100"
        (click)="agregarNuevoProducto()"
        [disabled]="!nuevoProducto.productoId || !nuevoProducto.sucursalId"
      >
        Agregar al Inventario
      </button>
    </div>
  </div>
</div>

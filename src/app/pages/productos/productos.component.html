<div class="container-fluid min-vh-100 py-4">
  <div class="row">
    <h2 class="text-center fw-bold mb-4">PRODUCTOS</h2>

    <div class="row justify-content-center mb-4 gap-2 px-3 flex-wrap text-center">
      <div class="col-auto">
        <div class="input-group rounded-pill d-flex align-items-center">
          <span class="input-group-text border-end-0" style="line-height: 1">
            <span class="material-symbols-outlined" style="font-size: 24px; vertical-align: middle">search</span>
          </span>
          <input
            type="text"
            class="form-control border-start-0"
            placeholder="Filtrar producto"
            [(ngModel)]="searchTerm"
            (input)="applyFilter()"
          />
        </div>
      </div>

      <div class="col-auto">
        <button
          class="form-control rounded-pill px-4 py-2 d-flex align-items-center gap-2 bg-success-subtle"
          (click)="abrirModalNuevoProducto()"
        >
          <span class="material-symbols-outlined text-success">add</span>
          Nuevo Producto
        </button>
      </div>
    </div>
  </div>

  <div class="table-responsive px-3">
    <table mat-table [dataSource]="dataSource" class="mat-elevation-z8" matSort>
      <ng-container matColumnDef="nombre">
        <th mat-header-cell *matHeaderCellDef matSortHeader class="text-center">PRODUCTO</th>
        <td mat-cell *matCellDef="let producto" class="text-center">{{ producto.nombre }}</td>
      </ng-container>

      <ng-container matColumnDef="categoria">
        <th mat-header-cell *matHeaderCellDef matSortHeader class="text-center">CATEGORÍA</th>
        <td mat-cell *matCellDef="let producto" class="text-center">{{ producto.categoria }}</td>
      </ng-container>

      <ng-container matColumnDef="precioUnitario">
        <th mat-header-cell *matHeaderCellDef matSortHeader class="text-center">PRECIO UNITARIO</th>
        <td mat-cell *matCellDef="let producto" class="text-center">
          {{ producto.precioUnitario | currency:'CLP':'$':'1.0-0' }}
        </td>
      </ng-container> 

      <ng-container matColumnDef="cantidadYUnidad">
        <th mat-header-cell *matHeaderCellDef matSortHeader class="text-center">CONTENIDO</th>
        <td mat-cell *matCellDef="let producto" class="text-center">
          {{ producto.cantidadUnidadMedida }} {{ producto.unidadMedida }}
        </td>
      </ng-container>

      <ng-container matColumnDef="estado">
        <th mat-header-cell *matHeaderCellDef matSortHeader class="text-center">ESTADO</th>
        <td mat-cell *matCellDef="let producto" class="text-center">
          <span [class]="producto.estado === 'ACTIVO' ? 'text-success' : 'text-danger'">
            {{ producto.estado }}
          </span>
        </td>
      </ng-container>

      <ng-container matColumnDef="opciones">
        <th mat-header-cell *matHeaderCellDef class="text-center">OPCIONES</th>
        <td mat-cell *matCellDef="let producto" class="text-center">
          <span
            class="material-symbols-outlined mx-1"
            style="cursor: pointer"
            (click)="abrirEditor(producto)"
            title="Editar Producto"
            >settings</span
          >
          <span
            class="material-symbols-outlined text-danger mx-1"
            style="cursor: pointer"
            (click)="solicitarConfirmacionEliminar(producto)"
            title="Eliminar Producto"
            >delete</span
          >
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
    </table>

    <mat-paginator [pageSizeOptions]="[10, 25, 50, 100]" showFirstLastButtons></mat-paginator>
  </div>

  <!-- Modal de Confirmación -->
  <div class="overlay" *ngIf="mostrarModalConfirmacion">
    <div class="edit-card">
      <h2>{{ mensajeConfirmacion }}</h2>
      <div class="modal-buttons">
        <button class="confirm-button" (click)="confirmarAccion()">CONFIRMAR</button>
        <button class="cancel-button" (click)="cerrarModalConfirmacion()">CANCELAR</button>
      </div>
    </div>
  </div>

  <!-- Modal de Edición -->
  <div class="overlay" *ngIf="selectedProducto" (click)="cerrarEditor()">
    <div class="edit-card" (click)="$event.stopPropagation()">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="m-0">Editar Producto</h5>
        <button class="btn-close" aria-label="Cerrar" (click)="cerrarEditor()"></button>
      </div>

      <div *ngIf="validationError" class="alert alert-danger py-1">
        {{ validationError }}
      </div>

      <div>
        <label class="form-label">Nombre <span class="text-danger">*</span></label>
        <input
          type="text"
          class="form-control mb-2"
          [(ngModel)]="selectedProducto.nombre"
          required
        />

        <label class="form-label">Categoría <span class="text-danger">*</span></label>
        <input
          type="text"
          class="form-control mb-2"
          [(ngModel)]="selectedProducto.categoria"
          required
        />

        <label class="form-label">Precio Unitario <span class="text-danger">*</span></label>
        <input
          type="text"
          class="form-control mb-2"
          [(ngModel)]="precioUnitarioString"
          (input)="actualizarPrecioUnitario()"
          required
          placeholder="Ingrese el precio"
        />

        <div class="row">
          <div class="col-6">
            <label class="form-label">Cantidad <span class="text-danger">*</span></label>
            <input
              type="number"
              class="form-control mb-2"
              [(ngModel)]="selectedProducto.cantidadUnidadMedida"
              required
              min="0"
              step="0.01"
            />
          </div>
          <div class="col-6">
            <label class="form-label">Unidad de Medida <span class="text-danger">*</span></label>
            <select class="form-select mb-2" [(ngModel)]="selectedProducto.unidadMedida" required>
              <option value="g">g</option>
              <option value="cc">cc</option>
            </select>
          </div>
        </div>

        <label class="form-label">Estado <span class="text-danger">*</span></label>
        <select class="form-select mb-2" [(ngModel)]="selectedProducto.estado" required>
          <option value="ACTIVO">ACTIVO</option>
          <option value="INACTIVO">INACTIVO</option>
        </select>

        <label class="form-label">Descripción</label>
        <textarea
          class="form-control mb-3"
          rows="2"
          [(ngModel)]="selectedProducto.descripcion"
        ></textarea>

        <button class="btn btn-success w-100" (click)="guardarProducto()">
          Guardar
        </button>
      </div>
    </div>
  </div>

  <!-- Modal de Nuevo Producto -->
  <div class="overlay" *ngIf="mostrarModalNuevoProducto" (click)="cerrarModalNuevoProducto()">
    <div class="edit-card" (click)="$event.stopPropagation()">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="m-0">Nuevo Producto</h5>
        <button class="btn-close" aria-label="Cerrar" (click)="cerrarModalNuevoProducto()"></button>
      </div>

      <div *ngIf="newProductoValidationError" class="alert alert-danger py-1">
        {{ newProductoValidationError }}
      </div>

      <div>
        <label class="form-label">Nombre <span class="text-danger">*</span></label>
        <input
          type="text"
          class="form-control mb-2"
          [(ngModel)]="nuevoProducto.nombre"
          required
        />

        <label class="form-label">Categoría <span class="text-danger">*</span></label>
        <input
          type="text"
          class="form-control mb-2"
          [(ngModel)]="nuevoProducto.categoria"
          required
        />

        <label class="form-label">Precio Unitario <span class="text-danger">*</span></label>
        <input
          type="text"
          class="form-control mb-2"
          [(ngModel)]="nuevoPrecioUnitarioString"
          (input)="actualizarNuevoPrecioUnitario()"
          required
          placeholder="Ingrese el precio"
        />

        <div class="row">
          <div class="col-6">
            <label class="form-label">Cantidad <span class="text-danger">*</span></label>
            <input
              type="number"
              class="form-control mb-2"
              [(ngModel)]="nuevoProducto.cantidadUnidadMedida"
              required
              min="0"
              step="0.01"
            />
          </div>
          <div class="col-6">
            <label class="form-label">Unidad de Medida <span class="text-danger">*</span></label>
            <select class="form-select mb-2" [(ngModel)]="nuevoProducto.unidadMedida" required>
              <option value="g">g</option>
              <option value="cc">cc</option>
            </select>
          </div>
        </div>

        <label class="form-label">Estado <span class="text-danger">*</span></label>
        <select class="form-select mb-2" [(ngModel)]="nuevoProducto.estado" required>
          <option value="ACTIVO">ACTIVO</option>
          <option value="INACTIVO">INACTIVO</option>
        </select>

        <label class="form-label">Descripción</label>
        <textarea
          class="form-control mb-3"
          rows="2"
          [(ngModel)]="nuevoProducto.descripcion"
        ></textarea>

        <button class="btn btn-success w-100" (click)="agregarNuevoProducto()">
          Agregar Producto
        </button>
      </div>
    </div>
  </div>
</div> 
<div class="container-fluid bg-warning-subtle min-vh-100 py-4">
  <div class="row">
    <h2 class="text-center fw-bold mb-4">SUCURSALES</h2>

    <div
      class="row justify-content-center mb-4 gap-2 px-3 flex-wrap text-center"
    >
      <div class="col-auto">
        <mat-form-field>
          <mat-label>Sucursal</mat-label>
          <mat-select>
            <mat-option value="todas">Todas</mat-option>
            <mat-option value="sucursal1">Central/Matriz</mat-option>
            <mat-option value="sucursal2">Puente Alto</mat-option>
          </mat-select>
        </mat-form-field>
      </div>

      <div class="col-auto">
        <div class="input-group rounded-pill d-flex align-items-center">
          <span
            class="input-group-text bg-white border-end-0"
            style="line-height: 1"
          >
            <span
              class="material-symbols-outlined"
              style="font-size: 24px; vertical-align: middle"
              >search</span
            >
          </span>
          <input
            type="text"
            class="form-control border-start-0"
            placeholder="Filtrar sucursal"
            [(ngModel)]="searchTerm"
            (input)="applyFilter()"
          />
        </div>
      </div>

      <div class="col-auto">
        <button
          class="form-control rounded-pill px-4 py-2 d-flex align-items-center gap-2 bg-success-subtle"
          (click)="abrirModalNuevaSucursal()"
        >
          <span class="material-symbols-outlined text-success">add</span>
          Nueva Sucursal
        </button>
      </div>
    </div>
  </div>

  <div class="table-responsive px-3">
    <table
      mat-table
      [dataSource]="dataSourceSucursales"
      class="mat-elevation-z8"
      matSort
    >
      <ng-container matColumnDef="id">
        <th mat-header-cell *matHeaderCellDef matSortHeader>ID</th>
        <td mat-cell *matCellDef="let sucursal">{{ sucursal.id }}</td>
      </ng-container>

      <ng-container matColumnDef="nombre">
        <th mat-header-cell *matHeaderCellDef matSortHeader>Sucursal</th>
        <td mat-cell *matCellDef="let sucursal">
          {{ sucursal.nombre }}
        </td>
      </ng-container>

      <ng-container matColumnDef="ventas">
        <th mat-header-cell *matHeaderCellDef matSortHeader>Ventas</th>
        <td mat-cell *matCellDef="let sucursal">
          {{ sucursal.ventas | currency : "CLP" : "$" : "1.0-0" }}
        </td>
      </ng-container>

      <ng-container matColumnDef="ultimoPedido">
        <th mat-header-cell *matHeaderCellDef matSortHeader>Último pedido</th>
        <td mat-cell *matCellDef="let sucursal">
          {{ sucursal.ultimoPedido | date : "dd-MM-yyyy" }}
        </td>
      </ng-container>

      <ng-container matColumnDef="opciones">
        <th mat-header-cell *matHeaderCellDef>OPCIONES</th>
        <td mat-cell *matCellDef="let sucursal">
          <span
            class="material-symbols-outlined mx-1"
            style="cursor: pointer"
            (click)="abrirEditorSucursal(sucursal)"
            title="Editar Sucursal"
            >settings</span
          >
          <span
            class="material-symbols-outlined mx-1"
            style="cursor: pointer"
            (click)="solicitarConfirmacionGuardadoSucursal(sucursal)"
            title="Guardar Cambios"
            >save</span
          >
          <span
            class="material-symbols-outlined text-danger mx-1"
            style="cursor: pointer"
            (click)="solicitarConfirmacionEliminarSucursal(sucursal)"
            title="Eliminar Sucursal"
            >delete</span
          >
        </td>
      </ng-container>

      <ng-container matColumnDef="movimientos">
        <th mat-header-cell *matHeaderCellDef>MOVIMIENTOS</th>
        <td mat-cell *matCellDef="let sucursal">
          <button
            class="btn btn-sm btn-info text-dark rounded-pill"
            (click)="abrirModalMovimientos(sucursal)"
          >
            <span class="material-symbols-outlined" style="font-size: 20px"
              >receipt_long</span
            >
            Ver
          </button>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumnsSucursales"></tr>
      <tr
        mat-row
        *matRowDef="let sucursal; columns: displayedColumnsSucursales"
      ></tr>
    </table>

    <mat-paginator
      [pageSizeOptions]="[10, 25, 50, 100]"
      showFirstLastButtons
    ></mat-paginator>
  </div>

  <div class="overlay confirm-overlay" *ngIf="mostrarModalConfirmacion">
    <div class="edit-card">
      <h2>{{ mensajeConfirmacion }}</h2>
      <div class="modal-buttons">
        <button class="confirm-button" (click)="confirmarAccionSucursal()">
          CONFIRMAR
        </button>
        <button class="cancel-button" (click)="cerrarModalConfirmacion()">
          CANCELAR
        </button>
      </div>
    </div>
  </div>

  <div
    class="overlay"
    *ngIf="selectedSucursal"
    (click)="cerrarEditorSucursal()"
  >
    <div class="edit-card" (click)="$event.stopPropagation()">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="m-0">Editar Sucursal</h5>
        <button
          class="btn-close"
          aria-label="Cerrar"
          (click)="cerrarEditorSucursal()"
        ></button>
      </div>

      <div *ngIf="validationError" class="alert alert-danger py-1">
        {{ validationError }}
      </div>

      <div>
        <label class="form-label">ID de Sucursal</label>
        <input
          type="text"
          class="form-control mb-2"
          [(ngModel)]="selectedSucursal.id"
          disabled
          title="El ID no se puede editar"
        />

        <label class="form-label">Nombre de Sucursal</label>
        <input
          type="text"
          class="form-control mb-2"
          [(ngModel)]="selectedSucursal.nombre"
        />

        <label class="form-label">Ventas</label>
        <input
          type="number"
          class="form-control mb-2"
          [(ngModel)]="selectedSucursal.ventas"
        />

        <label class="form-label">Último Pedido</label>
        <input
          type="date"
          class="form-control mb-3"
          [(ngModel)]="selectedSucursal.ultimoPedido"
        />

        <button class="btn btn-success w-100" (click)="guardarSucursal()">
          Guardar
        </button>
      </div>
    </div>
  </div>

  <div
    class="overlay"
    *ngIf="mostrarModalNuevaSucursal"
    (click)="cerrarModalNuevaSucursal()"
  >
    <div class="edit-card" (click)="$event.stopPropagation()">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="m-0">Nueva Sucursal</h5>
        <button
          class="btn-close"
          aria-label="Cerrar"
          (click)="cerrarModalNuevaSucursal()"
        ></button>
      </div>

      <div *ngIf="newSucursalValidationError" class="alert alert-danger py-1">
        {{ newSucursalValidationError }}
      </div>

      <div>
        <label class="form-label">Nombre de Sucursal</label>
        <input
          type="text"
          class="form-control mb-2"
          [(ngModel)]="nuevaSucursal.nombre"
          required
        />

        <label class="form-label">Ventas</label>
        <input
          type="number"
          class="form-control mb-2"
          [(ngModel)]="nuevaSucursal.ventas"
          required
        />

        <label class="form-label">Último Pedido</label>
        <input
          type="date"
          class="form-control mb-3"
          [(ngModel)]="nuevaSucursal.ultimoPedido"
          required
        />

        <button class="btn btn-success w-100" (click)="agregarNuevaSucursal()">
          Agregar Sucursal
        </button>
      </div>
    </div>
  </div>

  <div
    class="overlay"
    *ngIf="mostrarModalMovimientos"
    (click)="cerrarModalMovimientos()"
  >
    <div
      class="edit-card"
      style="max-width: 800px; width: 95%"
      (click)="$event.stopPropagation()"
    >
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h5 class="m-0">
          Movimientos de Sucursal:
          <span class="text-success fw-bold">{{
            selectedSucursalMovimientos?.nombre | uppercase
          }}</span>
        </h5>
        <button
          class="btn-close"
          aria-label="Cerrar"
          (click)="cerrarModalMovimientos()"
        ></button>
      </div>

      <div class="table-responsive">
        <table
          mat-table
          [dataSource]="dataSourceMovimientos"
          class="mat-elevation-z4"
          matSort
          #movimientosSort="matSort"
        >
          <ng-container matColumnDef="producto">
            <th mat-header-cell *matHeaderCellDef matSortHeader>PRODUCTO</th>
            <td mat-cell *matCellDef="let mov">{{ mov.producto }}</td>
          </ng-container>

          <ng-container matColumnDef="cantidad">
            <th mat-header-cell *matHeaderCellDef matSortHeader>CANTIDAD</th>
            <td mat-cell *matCellDef="let mov">{{ mov.cantidad }}</td>
          </ng-container>

          <ng-container matColumnDef="stock">
            <th mat-header-cell *matHeaderCellDef matSortHeader>STOCK</th>
            <td mat-cell *matCellDef="let mov">{{ mov.stock }}</td>
          </ng-container>

          <ng-container matColumnDef="tipoMovimiento">
            <th mat-header-cell *matHeaderCellDef matSortHeader>
              HISTORIAL MOVIMIENTOS
            </th>
            <td mat-cell *matCellDef="let mov">
              {{ mov.tipoMovimiento }}
              <ng-container *ngIf="mov.tipoMovimiento === 'ENTRADA'">
                <img
                  src="assets/logos/arrow_in.png"
                  alt="Entrada"
                  class="movement-arrow"
                />
              </ng-container>
              <ng-container *ngIf="mov.tipoMovimiento === 'SALIDA'">
                <img
                  src="assets/logos/arrow_out.png"
                  alt="Salida"
                  class="movement-arrow"
                />
              </ng-container>
            </td>
          </ng-container>

          <ng-container matColumnDef="fecha">
            <th mat-header-cell *matHeaderCellDef matSortHeader>FECHA</th>
            <td mat-cell *matCellDef="let mov">
              {{ mov.fecha | date : "dd/MM/yyyy" }}
            </td>
          </ng-container>

          <tr
            mat-header-row
            *matHeaderRowDef="displayedColumnsMovimientos"
          ></tr>
          <tr
            mat-row
            *matRowDef="let row; columns: displayedColumnsMovimientos"
          ></tr>
        </table>
        <mat-paginator
          #movimientosPaginator="matPaginator"
          [pageSizeOptions]="[5, 10, 20]"
          showFirstLastButtons
        ></mat-paginator>
      </div>

      <div class="d-flex justify-content-end mt-3">
        <button
          class="btn btn-success px-4 py-2"
          (click)="exportarMovimientosAExcel()"
        >
          Exportar en Excel
        </button>
      </div>
    </div>
  </div>
</div>
